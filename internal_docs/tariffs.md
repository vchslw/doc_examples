---
description: >-
  Обезличенная документация по устройству тарифов веб-сервиса. Целевая аудитория
  — сотрудники компании, которым нужно знать логику работы продукта
  (тестировщики, разработчики, техподдержка и т. д.).
---

# Тарифы

## Виды тарифов

Тариф привязывается **к пользователю** и действует для всех его компаний.

Тарифы делятся на тарифы Заказчика и тарифы Исполнителя и отличаются размером комиссии с входящих сделок.

* **Заказчик** — это пользователь, у всех компаний которого отключен чекбокс «Предоставляет услуги», то есть в `iam.companies.settings` параметр `isProvider` в значении `false`.\
  Такие компании не могут получать входящие задачи — поэтому в условиях тарифов Заказчика нет комиссии с входящих сделок.
* **Исполнитель** — пользователь, у которого предоставление услуг включено хотя бы в одной компании (`isProvider` в  значении `true`). При этом, подтверждена ли эта компания Админом, не имеет значения.\
  Компания с включенным предоставлением услуг может как создавать исходящие задачи, так и получать входящие.

Для Админов и пользователей, которые не создавали своих компаний, тарифов не предусмотрено. У таких пользователей на вкладке «Тарифы» в профиле не отображаются условия тарифа, а поле выбора компании для оплаты подписки неактивно.

## Изменение тарифа

{% hint style="warning" %}
После изменения тарифа стоимость всех задач с неподтвержденным КП во всех компаниях пользователя пересчитывается с учетом размера комиссии по новому тарифу.

Стоимость задач с подтвержденным КП остается прежней.

[Подробнее](tariffs.md#oplata-tarifa).
{% endhint %}

### Изменение тарифа при включении/отключении предоставления услуг

По умолчанию **при регистрации и создании первой компании** для пользователя устанавливается:

* Бесплатный тариф Заказчика — если `isProvider` в значении `false`.
* Бесплатный тариф Исполнителя — если `isProvider` в значении `true`. Тариф устанавливается сразу после включения параметра, до подтверждения компании Админом.

При включении и отключении предоставления услуг **в уже созданных компаниях** логика следующая:

* Если во всех компаниях пользователя отключен параметр «Предоставляет услуги», после его включения хотя бы в одной компании пользователь перейдет на бесплатный тариф Исполнителя.
* Если параметр «Предоставляет услуги» включен во всех компаниях пользователя, либо в части из них, пользователь не сможет перейти на тариф Заказчика, пока среди его компаний есть хотя бы одна компания с включенным предоставлением услуг.\
  Отключив предоставление услуг во всех своих компаниях, пользователь перейдет на бесплатный тариф Заказчика.

{% hint style="info" %}
Во всех случаях, если у пользователя был платный тариф, **при автоматическом переходе на бесплатный**, компании пользователя, которая выбрана для оплаты подписки, [начисляется возврат средств](tariffs.md#vozvrat-sredstv-za-podpisku) за неиспользованное время платного тарифа.
{% endhint %}

### Изменение тарифа вручную

Пользователь **не может** самостоятельно сменить свой текущий тариф на другой.

Чтобы сменить тариф:

1. Пользователь обращается к аккаунт-менеджеру.
2. Аккаунт-менеджер передает ID пользователя и название тарифа второй линии поддержки.
3. Сотрудник поддержки меняет тариф пользователя вручную — с помощью эндпоинта IAM POST `/subs`. В теле запроса передается [ID тарифа](tariffs.md#usloviya-tarifov).

{% hint style="info" %}
Если у пользователя был платный тариф, срок действия которого еще не истек, и ему изменили тариф на любой другой, компании, которая выбрана для оплаты подписки, возвращаются средства за оставшийся период.
{% endhint %}

<details>

<summary>У компании достаточно денег для оплаты тарифа, но POST <code>/subs</code> возвращает 400 <code>You do not have enough money</code>. В чем дело?</summary>

Возможны четыре причины такого поведения:

* В профиле пользователя на вкладке «Тарифы» выбрана другая компания, на балансе которой денег недостаточно.
* Вы пытаетесь установить тариф Заказчика пользователю, среди компаний которого есть хотя бы одна компания с включенным предоставлением услуг.
* Или, наоборот, пытаетесь установить тариф Исполнителя пользователю, у которого ни в одной компании не включен параметр `isProvider`.
* Денег, действительно, недостаточно — разницы между суммой зарезервированных списаний и текущим балансом компании не хватает, чтобы оплатить тариф.

</details>

## Продление тарифа

После установки пользователю платного тарифа в `billing.transactions` создается транзакция по оплате подписки, в которой фиксируются дата и время по UTC:

* `billed_at` — дата и время создания этой транзакции.
* `next_billed_at` — дата и время, в которые будет создана новая транзакция для продления тарифа и его оплаты. Рассичтывается как `billed_at` + один месяц.

Все тарифы продлеваются автоматически, но если у компании, с баланса которой оплачивается подписка, на момент продления **недостаточно средств**, [тариф сбросится на бесплатный](tariffs.md#oplata-pri-izmenenii-i-avtomaticheskom-prodlenii-tekushego-tarifa).\
У пользователя останутся все его компании и ОИС, созданные в них. Но если их количество больше или равно максимальному количеству на бесплатном тарифе, создать новую компанию или ОИС будет невозможно.

{% hint style="info" %}
Бесплатный и индивидуальный тариф с нулевой стоимостью продлеваются автоматически, независимо от баланса компании.
{% endhint %}

## Оплата тарифа

### Покупка подписки при регистрации

Если пользователь покупает платную подписку при регистрации:

* Стоимость тарифа автоматически списывается с текущего баланса первой созданной им компании. Баланс компании уходит в минус.
* В `billing.transactions` создается транзакция «Оплата лицензии за использование платформы» в статусе `DONE`.
* Оплата исходящей и создание входящей задач невозможны, пока баланс не будет пополнен до нуля или больше.

### Оплата при изменении и автоматическом продлении текущего тарифа

При изменении тарифа на новый и при автоматическом продлении текущего платного тарифа:

* **Оплата** списывается с текущего баланса компании, выбранной на вкладке «Тарифы» в профиле пользователя. Если компания для оплаты тарифа не выбрана, деньги списываются с текущего баланса первой компании, созданной пользователем.\
  Доступные средства автоматически пересчитываются с учетом нового значения текущего баланса.
* По оплате тарифа в `billing.transactions` создается **транзакция** «Оплата лицензии за использование платформы» в статусе `DONE`.
* Сумма транзакции **конвертируется в валюту компании** стандартно (если валюта компании не доллары и не рубли — через рубль по курсу ЦБ + 20 копеек).
* Если **доступных средств компании недостаточно** (ноль, отрицательный баланс, либо разницы между суммой зарезервированных списаний и текущим балансом недостаточно) — смена тарифа невозможна. POST `/subs` вернет ошибку 400 `You do not have enough money`.\
  При **автоматическом продлении** тарифа в таком случае тариф автоматически сбросится на бесплатный.
* Если дата продления тарифа еще не наступила, и пользователю изменили тариф, то компании, с баланса которой оплачивается тариф, [**возвращается часть средств**](tariffs.md#vozvrat-sredstv-za-podpisku), оплаченных за подписку.

{% hint style="info" %}
**Индивидуальный тариф с нулевой стоимостью** и **бесплатный** продлеваются автоматически, независимо от баланса компании.
{% endhint %}

### Возврат средств за подписку

Если пользователю изменили тариф раньше даты продления предыдущего тарифа, то компании, которая выбрана для оплаты подписки, возвращается часть средств:

* Автоматически рассчитывается неиспользованное время тарифа в секундах.
* От стоимости тарифа рассчитывается стоимость оставшегося времени.
* Стоимость оставшегося времени начисляется на баланс компании.
* В `billing.transactions` создается транзакция «Возврат средств за подписку» в статусе `DONE`.
* Если валюта компании не доллары, сумма транзакции конвертируется в валюту компании через рубль по курсу ЦБ на момент оплаты оплаты тарифа, по которому производится возврат, + 20 копеек.

<details>

<summary>Пример расчета суммы возврата</summary>

**Условия**:

* Тариф компании: «Бизнес», 349 $ в месяц, до 10 июня.
* Базовая валюта компании: евро.
* Сегодня: 5 июня.
* Меняем тариф пользователя на «Старт», стоимостью 149 $ в месяц.
* Курс доллара на 10 мая: 74.14 ₽.
* Курс евро на 10 мая: 89.51 ₽.

**Расчет суммы возврата**:

1. В транзакции по оплате тарифа «Бизнес» смотрим поле `date`:\
   `"2021-05-10T13:59:54.779Z"`
2. Меняем пользователю тариф на «Старт».
3. То есть тариф нужно было бы продлить 10 июня в 13:59:54.779 по UTC — это был бы полный месяц использования тарифа.
4. Рассчитываем фактическое время, в течение которого использовался тариф «Бизнес»:
   * Период с 10 мая 13:59:54.779 до 4 июня 13:59:54.779 — это полные 25 суток.\
     <mark style="color:blue;">25 суток = 600 часов = 36000 минут = 2160000 секунд</mark>\

   * Также нужно учесть период времени четвертого июня с 13:59:54.779 до конца дня. То есть из 24 часов отнять 13 часов 59 минут 54.779 секунд.\
     Поэтому сначала переводим 24 часа в секунды:\
     <mark style="color:blue;">24 часа = 1440 минут = 86400 секунд</mark>\

   * Затем переводим в секунды время, которое нужно отнять из 24 часов:\
     <mark style="color:blue;">13 часов 59 минут 54.779 секунд = 839 минут 54.779 секунд = 50394.779 секунд</mark>\

   * И считаем:\
     <mark style="color:blue;">86400 секунд - 50394.779 секунд = 36005.221 секунд</mark>\

   * Смотрим поле `date` в транзакции по возврату средств:\
     `"2021-06-05T07:44:24.057Z"`\

   * 7 часов 44 минуты 24.057 секунд в `date` — это время, в течение которого за сегодняшний день использовался старый тариф. Переводим это время в секунды:\
     <mark style="color:blue;">7 часов 44 минуты 24.057 секунд = 464 минуты 24.057 секунд = 27864.057 секунд</mark>\

   * Получив все нужные значения, суммируем их:\
     <mark style="color:blue;">25 полных суток + время до конца 4-го июня + время за пятое июня = 2160000 + 36005.221 + 27864.057 = 2223869.278 секунд</mark>\
     **Это время, в течение которого у пользователя был тариф «Бизнес»**.
5. Чтобы узнать, сколько стоит это время, рассчитаем стоимость одной секунды использования тарифа. Для этого переводим 31 сутки (т. к. в мае 31 день) в секунды:\
   <mark style="color:blue;">31 сутки = 744 часов = 44640 минут = 2678400 секунд</mark>
6. А затем делим стоимость тарифа на полученное значение:\
   \
   <mark style="color:blue;">349 ÷ 2678400 = 0.000130301 $</mark>\
   **Это стоимость одной секунды использования тарифа «Бизнес»**.
7. И затем умножаем стоимость одной секунды на количество времени, в течение которого у пользователя был тариф «Бизнес»:\
   <mark style="color:blue;">0.000130301 х 2223869.278 = 289.7723907 $</mark>\
   **Это стоимость тарифа «Бизнес» за использованное время**.
8. Затем, чтобы узнать сумму возврата средств за подписку, вычитаем полученное значение из полной стоимости тарифа (из 349 $):\
   \
   <mark style="color:blue;">349 - 289.7723907 = 59.2276092 $</mark>\
   Округляем полученное значение до 59.23 $.\
   **Это размер транзакции по возврату средств за подписку в долларах**.
9. Теперь сумма возврата известна, осталось только сконвертировать её в валюту компании.\
   Поскольку пользователь оплатил тариф 10 мая, в конвертации мы используем курсы валют на 10 мая.
   * Сначала переводим 59.23 $ в рубли по курсу ЦБ + 20 копеек:\
     <mark style="color:blue;">59.23 х (74.14 + 0.2) = 4403.16 ₽</mark>\

   * Теперь конвертируем сумму в рублях в евро (по курсу на 10 мая):\
     <mark style="color:blue;">4403.16 ÷ 89.51 = 49.1918 €</mark>\

   * Округляем математически до второго знака после запятой и получаем **49.19 €** — это и будет **сумма возврата средств за подписку**. То есть стоимость неиспользованного времени действия тарифа «Бизнес» в валюте компании.

</details>

### Возврат средств после смены компании для оплаты

Сумма возврата [рассчитывается так же](tariffs.md#vozvrat-sredstv-za-podpisku), как в случае, если компания для оплаты не была изменена, но сумма в долларах конвертируется в валюту компании **по курсу на момент возврата средств**:

* Рассчитывается неиспользованное время тарифа.
* Рассчитывается стоимость этого времени.
* Сумма в долларах конвертируется в рубли **по текущему курсу ЦБ** + 20 копеек.
* Сумма в рублях конвертируется в валюту компании **по текущему курсу ЦБ**.

## Условия тарифов

### Тарифы Заказчика

|                                          | **Бесплатный**               | **Старт**                   | **Бизнес**                  | **Индивидуальный**          |
| ---------------------------------------- | ---------------------------- | --------------------------- | --------------------------- | --------------------------- |
| **Максимальное количество активных ОИС** | 30                           | 250                         | 1000                        | Не ограничено               |
| **Максимальное количество компаний**     | 2                            | 10                          | Не ограничено               | Не ограничено               |
| **Размер комиссии с исходящих сделок**   | <p>10%,<br>не менее 40 $</p> | <p>8%,<br>не менее 35 $</p> | <p>6%,<br>не менее 30 $</p> | <p>4%,<br>не менее 25 $</p> |
| **Ежемесячная плата**                    | 0                            | <p>9990 ₽<br>149 $</p>      | <p>24990 ₽<br>349 $</p>     | Индивидуально               |
| **ID**                                   | `4307c7468d92j4u67s910`      | `8sjf840v990ck8fj57fk9`     | `18f647dk392cn5hf8ch3n`     | `8djc64839s63j57ch29c7`     |

### Тарифы Исполнителя

|                                          | **Бесплатный**               | **Старт**                   | **Бизнес**                  | **Индивидуальный**          |
| ---------------------------------------- | ---------------------------- | --------------------------- | --------------------------- | --------------------------- |
| **Максимальное количество активных ОИС** | 30                           | 250                         | 1000                        | Не ограничено               |
| **Максимальное количество компаний**     | 2                            | 10                          | Не ограничено               | Не ограничено               |
| **Размер комиссии с исходящих сделок**   | <p>10%,<br>не менее 40 $</p> | <p>8%,<br>не менее 35 $</p> | <p>6%,<br>не менее 30 $</p> | <p>4%,<br>не менее 25 $</p> |
| **Размер комиссии с входящих сделок**    | 15%                          | 15%                         | 15%                         | 10%                         |
| **Интеграции**                           | —                            | —                           | Да\*                        | Да\*                        |
| **Ежемесячная плата**                    | 0                            | <p>9990 ₽<br>149 $</p>      | <p>24990 ₽<br>349 $</p>     | Индивидуально               |
| **ID**                                   | `8djc6489s63j57c3h29c7`      | `8sjf840v990ck48j57fk9`     | `18f647dk92jcn5hf8ch3n`     | `4307c74j68d924u67s910`     |

_\*На текущий момент доступна только интеграция с сервисом «Best IP», **только для зарубежных компаний** (проставляется в базе вручную)._
